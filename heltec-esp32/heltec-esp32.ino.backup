#include <WiFi.h>
#include <Wire.h>
#include "HT_SSD1306Wire.h"
#include <HardwareSerial.h>
#include <SPI.h>
#include <MFRC522.h>

// VARIABLES
const char* ssid = "kotinas";
const char* password = "rootroot";
#define RX_PIN 3  // RX pin connected to TX of RFID module
#define TX_PIN 1  // TX pin connected to RX of RFID module

// OTHER VARIABLES
#define OLED_UPDATE_INTERVAL 500
static SSD1306Wire  display(0x3c, 500000, SDA_OLED, SCL_OLED, GEOMETRY_128_64, RST_OLED);
HardwareSerial RFID(2); // Use UART2
const char* loraFrequency = "868.1";  // Set frequency to 868.1 MHz

// Function to configure LoRa module
void configureLoRa() {
  LoRaSerial.println("AT+MODE=LWABP");  // Example: Set LoRa mode
  delay(100);
  LoRaSerial.println("AT+FREQ=" + String(loraFrequency)); // Set frequency
  delay(100);
  Serial.println("LoRa Module Configured at 868.1 MHz");
}


void setup()
{
  display.init();
  display.clear();
  display.display();
  
  display.setContrast(255);
  Serial.begin(115200);

  while (!Serial) {
    ; // wait for serial port to connect. Needed for native USB port only
  }

  // LoRa Setup
  LoRaSerial.begin(9600, SERIAL_8N1, RX_PIN, TX_PIN); // Initialize UART for LoRa
  configureLoRa();
}

String readRFID() {
  String rfidData = "";

  // Display waiting message
  display.clear();
  display.drawString(0, 0, "Waiting for RFID card...");
  display.display();
  delay(1000);

  // Start RFID communication
  RFID.begin(9600, SERIAL_8N1, RX_PIN, TX_PIN);

  if (RFID.available()) {
    while (RFID.available()) {
      char c = RFID.read();
      rfidData += c;
    }

    // Display RFID data on screen
    display.clear();
    display.drawString(0, 0, "RFID card detected:");
    display.drawString(0, 10, rfidData);
    display.display();
    delay(500);

    // Display re-scan message
    display.drawString(0, 20, "Rerun scan in 2 seconds...");
    display.display();
  }
  return rfidData;
}

// Function to send a LoRa message
void sendLoRaMessage(String message) {
  LoRaSerial.println("AT+SEND=" + message);  // Example: Send data
  Serial.println("LoRa Message Sent: " + message);

  // Check for LoRa response
  if (LoRaSerial.available()) {
    String response = LoRaSerial.readString();
    Serial.println("LoRa Response: " + response);
  }
}

void loop() {
  String rfidMessage = readRFID();

  sendLoRaMessage("RFID:" + rfidMessage);

  delay(2000);
}
